name: Bazel test
on: [pull_request]

jobs:
  test:
    strategy:
      matrix:
        worker: [
          { name: 'c7n_first', path: 'tests:first_chunk' },
          { name: 'c7n_second', path: 'tests:second_chunk'},
          { name: 'c7n_third', path: 'tests:third_chunk'},
          { name: 'c7n_fourth', path: 'tests:fourth_chunk'},
          { name: 'c7n_azure', path: 'tools/c7n_azure/tests_azure' },
          { name: 'c7n_gcp', path: 'tools/c7n_gcp/tests' },
          { name: 'c7n_kube', path: 'tools/c7n_kube/tests' },
          { name: 'c7n_mailer', path: 'tools/c7n_mailer/tests' },
        ]
        # worker: [
        #          'tests:first_chunk',
        #          'tests:second_chunk',
        #          'tests:third_chunk',
        #          'tests:fourth_chunk',
        #          'tools/c7n_azure/tests_azure',
        #          'tools/c7n_gcp/tests',
        #          'tools/c7n_kube/tests',
        #          'tools/c7n_mailer/tests',
        # ]
    runs-on: ubuntu-18.04
    name: Test
    container:
      image: rushrecon/bazel2py:3.0.0
      #
      # Paths for cached directories described in https://docs.bazel.build/versions/master/output_directories.html#current-layout
      # MD5 hash of repo directory(i.e. '/__w/cloud-custodian/cloud-custodian') is gotten by using the next one-liner:
      # $ python3 -c "import hashlib;print(hashlib.md5(b'/__w/cloud-custodian/cloud-custodian').hexdigest())"
      #
      volumes:
        - /tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/external:/tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/external
        # - /tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/execroot:/tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/execroot
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Mount external cache
        uses: actions/cache@v1
        with:
          path: "/tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/external"
          key: bazel-ext-${{ matrix.worker.name }}
      # - name: Mount execroot cache
      #   uses: actions/cache@v1
      #   with:
      #     path: "/tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/execroot"
      #     key: bazel-exec-${{ matrix.worker.name }}
      - name: Execute bazel test //${{ matrix.worker.name }}
        run: bazel --output_user_root=/tmp/output_build test //${{ matrix.worker.path }}
