name: Bazel build wheels
on: [pull_request]

jobs:
  build:
    runs-on: ubuntu-18.04
    name: Build
    container:
      image: rushrecon/bazel2py:3.0.0
      #
      # Paths for cached directories described in https://docs.bazel.build/versions/master/output_directories.html#current-layout
      # MD5 hash of repo directory(i.e. '/__w/cloud-custodian/cloud-custodian') is gotten by using the next one-liner:
      # $ python3 -c "import hashlib;print(hashlib.md5(b'/__w/cloud-custodian/cloud-custodian').hexdigest())"
      #
      volumes:
        - /tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/external:/tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/external
        - /tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/execroot:/tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/execroot
        - /tmp/out:/tmp/out
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Mount external cache
        uses: actions/cache@v1
        with:
          path: "/tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/external"
          key: bazel-ext
      - name: Mount execroot cache
        uses: actions/cache@v1
        with:
          path: "/tmp/output_build/2ea0736f19907bdbf0b696f1c9b02a37/execroot"
          key: bazel-exec-wheel
      - name: Execute bazel build //:c7n_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_wheel
      - name: Execute bazel build //:c7n_azure_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_azure_wheel
      - name: Execute bazel build //:c7n_gcp_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_gcp_wheel
      - name: Execute bazel build //:c7n_kube_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_kube_wheel
      - name: Execute bazel build //:c7n_mailer_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_mailer_wheel
      - name: Collect wheels
        run: |
          for f in `find ./ -name "c7n*.whl"`; do
            whl=`echo $f | awk -F"-|_" '{ if ($2 ~ /[0-9\.]/) print "wheel"; else print $2; }'`;
            mkdir -p /tmp/out/$whl;
            mv $f /tmp/out/$whl/;
          done
      - name: Install wheels
        run: pip3 install /tmp/out/*/*.whl
      - name: Upload wheels into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_wheel
          path: /tmp/out/wheel
      - name: Upload wheels into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_azure_wheel
          path: /tmp/out/azure
      - name: Upload wheels into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_gcp_wheel
          path: /tmp/out/gcp
      - name: Upload wheels into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_kube_wheel
          path: /tmp/out/kube
      - name: Upload wheels into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_mailer_wheel
          path: /tmp/out/mailer
