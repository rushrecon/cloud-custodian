name: Bazel build wheels
on: [pull_request]

jobs:
  wheel_build:
    runs-on: ubuntu-18.04
    name: build:wheel
    container:
      image: johnybear/ubuntu_for_c7n_bazel:latest
      volumes:
        - /tmp/output_build:/tmp/output_build
        - /tmp/C7N-cov:/tmp/C7N-cov
        - /tmp/wheel:/tmp/wheel
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Cache deps
        id: cache-deps
        uses: actions/cache@v1
        with:
          path: /tmp/output_build
          key: output_build
      - name: Execute bazel build //:c7n_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_wheel
      - name: Getting generated whl files
        run: find /tmp/output_build/ -type f -name 'c7n*.whl' -exec cp -n -at /tmp/wheel {} +
      - name: Upload wheel into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_wheel
          path: /tmp/wheel
  wheel_azure:
    runs-on: ubuntu-18.04
    name: wheel:gcp
    container:
      image: johnybear/ubuntu_for_c7n_bazel:latest
      volumes:
        - /tmp/output_build:/tmp/output_build
        - /tmp/C7N-cov:/tmp/C7N-cov
        - /tmp/wheel:/tmp/wheel
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Cache deps
        id: cache-deps
        uses: actions/cache@v1
        with:
          path: /tmp/output_build
          key: output_build
      - name: Cache deps
        id: cache-deps
        uses: actions/cache@v1
        with:
          path: /tmp/output_build
          key: output_build
      - name: Execute bazel build //:c7n_azure_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_azure_wheel
      - name: Getting generated whl files
        run: find /tmp/output_build/ -type f -name 'c7n*.whl' -exec cp -n -at /tmp/wheel {} +
      - name: Upload wheel into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_azure_wheel
          path: /tmp/wheel
  wheel_gcp:
    runs-on: ubuntu-18.04
    name: wheel:gcp
    container:
      image: johnybear/ubuntu_for_c7n_bazel:latest
      volumes:
        - /tmp/output_build:/tmp/output_build
        - /tmp/C7N-cov:/tmp/C7N-cov
        - /tmp/wheel:/tmp/wheel
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Cache deps
        id: cache-deps
        uses: actions/cache@v1
        with:
          path: /tmp/output_build
          key: output_build
      - name: Execute bazel build //:c7n_gcp_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_gcp_wheel
      - name: Getting generated whl files
        run: find /tmp/output_build/ -type f -name 'c7n*.whl' -exec cp -n -at /tmp/wheel {} +
      - name: Upload wheel into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_gcp_wheel
          path: /tmp/wheel
  kube_wheel:
    runs-on: ubuntu-18.04
    name: wheel:kube
    container:
      image: johnybear/ubuntu_for_c7n_bazel:latest
      volumes:
        - /tmp/output_build:/tmp/output_build
        - /tmp/C7N-cov:/tmp/C7N-cov
        - /tmp/wheel:/tmp/wheel
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Cache deps
        id: cache-deps
        uses: actions/cache@v1
        with:
          path: /tmp/output_build
          key: output_build
      - name: Execute bazel build //:c7n_kube_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_kube_wheel
      - name: Getting generated whl files
        run: find /tmp/output_build/ -type f -name 'c7n*.whl' -exec cp -n -at /tmp/wheel {} +
      - name: Upload wheel into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_kube_wheel
          path: /tmp/wheel
  mailer_wheel:
    runs-on: ubuntu-18.04
    name: wheel:mailer
    container:
      image: johnybear/ubuntu_for_c7n_bazel:latest
      volumes:
        - /tmp/output_build:/tmp/output_build
        - /tmp/C7N-cov:/tmp/C7N-cov
        - /tmp/wheel:/tmp/wheel
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Cache deps
        id: cache-deps
        uses: actions/cache@v1
        with:
          path: /tmp/output_build
          key: output_build
      - name: Execute bazel build //:c7n_mailer_wheel
        run: bazel --output_user_root=/tmp/output_build build c7n_mailer_wheel
      - name: Getting generated whl files
        run: find /tmp/output_build/ -type f -name 'c7n*.whl' -exec cp -n -at /tmp/wheel {} +
      - name: Upload wheel into artifacts
        uses: actions/upload-artifact@v1
        with:
          name: c7n_mailer_wheel
          path: /tmp/wheel
